<!DOCTYPE html>
<meta charset="utf-8">
<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <!-- I recommend you host this file on your own, since this will change without warning -->
	<script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
	<div id="container1" style="background-color:#00ccff;"></div>
	
    <script>
    const cities = [
	{
		"name": "Barcelona",
		"latitude": "41.3851", 
		"longitude": "2.1734", 
		"flights": [
			{ "name": "London", "time": "145", "cost": "35", "emissions": 	"0.228"},
			{ "name": "New York", "time": "515", "cost": "197", "emissions": "0.997"},
			{ "name": "Prague", "time": "150", "cost": "51", "emissions": "0.261"}
		]
	},
	{ 
		"name": "London", 
		"latitude": "51.5074", 
		"longitude": "-0.1278", 
		"flights": [
			{ "name": "Moscow", "time": "225", "cost": "81", "emissions": "0.445"},
			{ "name": "New Delhi", "time": "550", "cost": "314", "emissions": "1.1"},
			{ "name": "Shanghai", "time": "670", "cost": "489", "emissions": "1.5"}
		]
	},
	{ 
		"name": "New York",
		"latitude": "40.7128", 
		"longitude": "-74.0060",
		"flights": [
			{ "name": "Toronto", "time": "100", "cost": "103", "emissions": "0.153"},
			{ "name": "Los Angeles", "time": "365", "cost": "107", "emissions": "0.497"},
			{ "name": "Rio de Janeiro", "time": "540", "cost": "733", "emissions": "1.3"}
		]
	},
	{ 
		"name": "Prague", 
		"latitude": "50.0755",
		"longitude": "14.4378",
		"flights": [
			{ "name": "London", "time": "125", "cost": "22", "emissions": "0.217"},
			{ "name": "Moscow", "time": "215", "cost": "100", "emissions": "0.287"},
			{ "name": "Dubai", "time": "370", "cost": "265", "emissions": "0.735"}
		]
	},
	{
		"name": "Tokyo",
		"latitude": "35.6762",
		"longitude": "139.6503",
		"flights": [
			{ "name": "Sydney", "time": "570", "cost": "466", "emissions": "1.3"},
			{ "name": "Shanghai", "time": "185", "cost": "317", "emissions": "0.320"},
			{ "name": "New Delhi", "time": "560", "cost": "711", "emissions": "0.958"}
		]
	},
	{
		"name": "Moscow", 
		"latitude": "55.7558", 
		"longitude": "37.6173", 
		"flights": [
			{ "name": "Dubai", "time": "315", "cost": "138", "emissions": "0.432"},
			{ "name": "New Delhi", "time": "360", "cost": "209", "emissions": "0.720"},
			{ "name": "Shanghai", "time": "525", "cost": "215", "emissions": "1.1"}
		]
	},
	{
		"name": "New Delhi", 
		"latitude": "28.6139", 
		"longitude": "77.2090",
		"flights": [
			{ "name": "Sydney", "time": "755", "cost": "412", "emissions": "1.7"},
			{ "name": "Shanghai", "time": "355", "cost": "298", "emissions": "0.666"},
			{ "name": "Dubai", "time": "215", "cost": "120", "emissions": "0.395"}
		]
	},
	{
		"name": "Rio de Janeiro", 
		"latitude": "-22.9068", 
		"longitude": "-43.1729", 
		"flights": [
			{ "name": "Sydney", "time": "960", "cost": "588", "emissions": "2.3"},
			{ "name": "Los Angeles", "time": "600", "cost": "449", "emissions": "1.7"},
			{ "name": "Dubai", "time": "800", "cost": "861", "emissions": "2.0"}
		]
	},
	{
		"name": "Toronto",
		"latitude": "43.6532", 
		"longitude": "-79.3832",
		"flights": [
			{ "name": "Shanghai", "time": "855", "cost": "421", "emissions": "1.7"},
			{ "name": "Los Angeles", "time": "321", "cost": "153", "emissions": "0.461"},
			{ "name": "Tokyo", "time": "780", "cost": "757", "emissions": "1.7"}
		]
	},
	{
		"name": "Dubai", 
		"latitude": "25.2048",
		"longitude": "55.2708",
		"flights": [
			{ "name": "Sydney", "time": "830", "cost": "1105", "emissions": "2.0"},
			{ "name": "New Delhi", "time": "200", "cost": "124", "emissions": "0.193"},
			{ "name": "Shanghai", "time": "530", "cost": "289", "emissions": "1.0"}
		]
	},
	{
		"name": "Shanghai", 
		"latitude": "31.2304", 
		"longitude": "121.4737", 
		"flights": [
			{ "name": "Sydney", "time": "635", "cost": "335", "emissions": "1.3"},
			{ "name": "New Delhi", "time": "375", "cost": "391", "emissions": "0.666"},
			{ "name": "Tokyo", "time": "175", "cost": "320", "emissions": "0.320"}
		]
	},
	{
		"name": "Los Angeles", 
		"latitude": "34.0522", 
		"longitude": "-118.2437", 
		"flights": [
			{ "name": "Sydney", "time": "905", "cost": "507", "emissions": "2.0"},
			{ "name": "Toronto", "time": "290", "cost": "205", "emissions": "0.461"},
			{ "name": "Tokyo", "time": "690", "cost": "367", "emissions": "1.4"}
		]
    },
    {
		"name": "Sydney", 
		"latitude": -33.8688, 
		"longitude": 151.2093, 
        "flights": []
    }
]
    //basic map config with custom fills, mercator projection
    var map = new Datamap({
        scope: 'world',
        geographyConfig: {
            popupOnHover: false,
            highlightOnHover: false
        },
        element: document.getElementById('container1'),
        projection: 'mercator',
        height: 500,
        fills: {
          defaultFill: '#00cc00',
		  previous : '#505050',
		  current : '#00ffff',
		  next : '#ffcc00',
		  goal : '#FF0000',
		  unvisited : '#FFFFFF', 
		  visited_arc: 'rgba(100, 100, 200, 0.8)'
        },
	})

	const start = search("Barcelona", cities)
	const goal = search("Sydney", cities)
	var route = [start]
	var latLng = map.latLngToXY(start.latitude, start.longitude);
	console.log(latLng)
    fly_to(start)

    function fly_to(current_loc) {
        var destinations = find_destination_info(current_loc)

		refresh_flight_widgets(current_loc, destinations)
		draw_arcs(map, current_loc, destinations)
        draw_bubbles(map, current_loc, destinations)
    }
	function refresh_flight_widgets(current_loc, destinations) {
		// If we are at the start, we have not yet generated any buttons, so don't delete them
		if (current_loc != cities[0]) {
            for (var j = 0; j < 3; j++){
                document.getElementById("button"+j).remove();
                document.getElementById("text"+j).remove();
            }
        }
		// generate buttons and text widgets for showing available flights
		var btns = []
        for (let i = 0; i < destinations.length; i++) {
			var wrapper = document.createElement("div");
			//wrapper.style.cssText = 'float: left';

			var txt = document.createElement("P");
			txt.style.cssText = 'display: inline-block;width: 50%'
            txt.setAttribute("id", "text"+i)
			txt.innerHTML = flight_description_string(current_loc.flights[i])
			wrapper.appendChild(txt);
            document.body.appendChild(txt);		

			var btn = document.createElement("BUTTON");
			btn.style.cssText = 'display: inline-block;width: 50%;font-size: 16px;background-color: #ffcc00; border: none; padding: 15px 25px; text-align: center;cursor: pointer;';
            btn.innerHTML = "Fly to " + destinations[i].name
			btn.setAttribute("id", "button"+i)
			
			var latLng = map.latLngToXY(destinations[i].latitude, destinations[i].longitude);
			btn.setAttribute("x", latLng[0])
			btn.setAttribute("y", latLng[1])

			wrapper.appendChild(btn);
            document.body.appendChild(btn);
			btns.push(btn)
			document.body.appendChild(wrapper)
        }
		if (btns.length == 3) {
			// if there are three places to go then there should be buttons to click
			// FIXME - this assumes there will be either 0 or 3 destinations
			btns[0].onclick = function() {
				route.push(destinations[0])
				fly_to(destinations[0])
			};
			btns[1].onclick = function() {
				route.push(destinations[1])
				fly_to(destinations[1])
			};
			btns[2].onclick = function() {
				route.push(destinations[2])
				fly_to(destinations[2])
			};
		}
	}
	function timeConvert(n) {
		var num = n;
		var hours = (num / 60);
		var rhours = Math.floor(hours);
		var minutes = (hours - rhours) * 60;
		var rminutes = Math.round(minutes);
		return rhours + "hrs " + rminutes + "min";
	}
    function flight_description_string(flight) {
        return "\nTime: " + timeConvert(flight.time) + 
        "\nCost: Â£" + flight.cost + 
        "\nEmissions: " + flight.emissions + " tonnes"
    }
    function find_destination_info(current_loc) {
        var destinations = []
        current_loc.flights.forEach(function(item) {
            destinations.push(search(item.name, cities))
        })
       
        return destinations
    }
	function draw_arcs(map, current_loc, destinations) {
        arcs = [];
		//Add arcs from current location to neighbours
        destinations.forEach(function(item) {
            arcs.push({origin: current_loc, destination: item})
        })
		//Add arcs between locations already visited
		for (let i = 0; i < route.length-1; i++) {
        	arcs.push({origin: route[i], destination: route[i+1], options: {strokeColor: "rgba(100, 100, 200, 0.8)"}})
		}
        map.arc(arcs, {strokeWidth: 3});
	}
    function draw_bubbles(map, current_loc, destinations) {
		//Add point for current location
		current_location_bubble = {...current_loc, radius: 8, fillKey: 'current'}

		//Add point for final goal
		goal_bubble = {...goal, radius: 15, fillKey: 'goal'}

		var bubbles = [current_location_bubble, goal_bubble]
		
		newCities = cities.filter( ( el ) => !destinations.includes( el ) && el != current_loc && el != goal );

		newCities.forEach(function(city) {
            bubbles.push({...city, radius: 5, fillKey: 'unvisited'})
		})
		//Add points for locations visitable from current
        destinations.forEach(function(city) {
            bubbles.push({...city, radius: 10, fillKey: 'next'})
        })

		//Add points for locations previously visited
		for (let i = 0; i < route.length-1; i++) {
        	bubbles.push({...route[i], radius: 5, fillKey: 'previous'})
		}

        map.bubbles(bubbles, {
            popupTemplate: function(geo, data) {
                return "<div class='hoverinfo'>"+data.name+"</div>";
            }
        });
    }
    function search(nameKey, myArray){
        for (var j=0; j < myArray.length; j++) {
            if (myArray[j].name === nameKey) {
                return myArray[j];
            }
        }
    }
    </script>
</body>